<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UN Speeches 2024 - Similarity Matrix</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 2.2em;
      }

      .subtitle {
        text-align: center;
        color: #7f8c8d;
        margin-bottom: 30px;
        font-size: 1.1em;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-group label {
        font-weight: 500;
        color: #34495e;
      }

      .control-group input,
      .control-group select {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .matrix-container {
        display: flex;
        justify-content: center;
        overflow: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
      }

      .tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 12px;
        border-radius: 6px;
        font-size: 13px;
        line-height: 1.4;
        max-width: 300px;
        pointer-events: none;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .legend {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        gap: 20px;
      }

      .legend-scale {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .legend-gradient {
        width: 200px;
        height: 20px;
        background: linear-gradient(to right, #f7fbff, #08519c);
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .legend-labels {
        display: flex;
        justify-content: space-between;
        width: 200px;
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      .stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        font-size: 14px;
        color: #666;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
      }

      .matrix-cell {
        cursor: pointer;
        stroke: white;
        stroke-width: 0.5;
      }

      .matrix-cell:hover {
        stroke: #333;
        stroke-width: 2;
      }

      .axis-label {
        font-size: 10px;
        fill: #666;
      }

      .country-group {
        fill: none;
        stroke: #999;
        stroke-width: 1;
        stroke-dasharray: 2, 2;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üåç UN General Assembly 2024</h1>
      <div class="subtitle">
        Speech Similarity Matrix - 40 Selected Countries
      </div>

      <div class="controls">
        <div class="control-group">
          <label for="threshold">Similarity Threshold:</label>
          <input
            type="range"
            id="threshold"
            min="0"
            max="1"
            step="0.01"
            value="0.3"
          />
          <span id="threshold-value">0.30</span>
        </div>
        <div class="control-group">
          <label for="cellSize">Cell Size:</label>
          <select id="cellSize">
            <option value="8">Small</option>
            <option value="12" selected>Medium</option>
            <option value="16">Large</option>
            <option value="20">Extra Large</option>
          </select>
        </div>
      </div>

      <div class="matrix-container">
        <svg id="matrix"></svg>
      </div>

      <div class="legend">
        <div class="legend-scale">
          <span>Low Similarity</span>
          <div class="legend-gradient"></div>
          <span>High Similarity</span>
        </div>
      </div>
      <div class="legend-labels" id="legend-labels">
        <span>0.0</span>
        <span>0.5</span>
        <span>1.0</span>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="total-speeches">-</div>
          <div>Total Speeches</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="avg-similarity">-</div>
          <div>Average Similarity</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="max-similarity">-</div>
          <div>Maximum Similarity</div>
        </div>
      </div>
    </div>

    <div class="tooltip" id="tooltip" style="display: none"></div>

    <script>
      // Load the similarity data
      fetch('./speech-similarity-2024.json')
        .then((response) => response.json())
        .then((data) => {
          console.log(
            'Loaded similarity data:',
            data.speeches.length,
            'speeches'
          )
          initializeVisualization(data)
        })
        .catch((error) => {
          console.error('Error loading data:', error)
        })

      function initializeVisualization(data) {
        const { speeches, similarities } = data

        // Update stats
        document.getElementById('total-speeches').textContent = speeches.length

        // Calculate statistics
        const allSimilarities = similarities.flat().filter((sim) => sim < 1.0)
        const avgSim =
          allSimilarities.reduce((a, b) => a + b, 0) / allSimilarities.length
        const maxSim = Math.max(...allSimilarities)

        document.getElementById('avg-similarity').textContent =
          avgSim.toFixed(3)
        document.getElementById('max-similarity').textContent =
          maxSim.toFixed(3)

        // Set up the visualization
        const svg = d3.select('#matrix')
        const tooltip = d3.select('#tooltip')

        // Color scale - use actual data range for better contrast
        const minSim = Math.min(...allSimilarities)
        const colorScale = d3
          .scaleSequential(d3.interpolateBlues)
          .domain([minSim, maxSim])

        // Update legend labels with actual range
        const legendLabels = document.getElementById('legend-labels')
        legendLabels.innerHTML = `
          <span>${minSim.toFixed(3)}</span>
          <span>${((minSim + maxSim) / 2).toFixed(3)}</span>
          <span>${maxSim.toFixed(3)}</span>
        `

        // Update threshold slider to use actual data range
        const thresholdSlider = document.getElementById('threshold')
        thresholdSlider.min = minSim.toFixed(3)
        thresholdSlider.max = maxSim.toFixed(3)
        thresholdSlider.value = minSim.toFixed(3)
        thresholdSlider.step = '0.001'
        document.getElementById('threshold-value').textContent =
          minSim.toFixed(3)

        let currentThreshold = minSim // Start with minimum to show all data
        let currentCellSize = 12

        function updateMatrix() {
          svg.selectAll('*').remove()

          const margin = { top: 100, right: 100, bottom: 100, left: 100 }
          const cellSize = currentCellSize
          const width = speeches.length * cellSize + margin.left + margin.right
          const height = speeches.length * cellSize + margin.top + margin.bottom

          svg.attr('width', width).attr('height', height)

          const g = svg
            .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`)

          // Create cells
          const cells = g
            .selectAll('.matrix-cell')
            .data(
              speeches.flatMap((speech1, i) =>
                speeches.map((speech2, j) => ({
                  i,
                  j,
                  speech1: speech1,
                  speech2: speech2,
                  similarity: similarities[i][j],
                  visible: similarities[i][j] >= currentThreshold,
                }))
              )
            )
            .enter()
            .append('rect')
            .attr('class', 'matrix-cell')
            .attr('x', (d) => d.j * cellSize)
            .attr('y', (d) => d.i * cellSize)
            .attr('width', cellSize)
            .attr('height', cellSize)
            .attr('fill', (d) =>
              d.visible ? colorScale(d.similarity) : '#f8f9fa'
            )
            .attr('opacity', (d) => (d.visible ? 1 : 0.3))
            .on('mouseover', function (event, d) {
              if (!d.visible) return

              const tooltipHtml = `
                            <strong>Similarity: ${d.similarity.toFixed(3)}</strong><br/>
                            <br/>
                            <strong>${d.speech1.country}</strong> - ${d.speech1.speaker}<br/>
                            <em>${d.speech1.title}</em><br/>
                            <br/>
                            <strong>${d.speech2.country}</strong> - ${d.speech2.speaker}<br/>
                            <em>${d.speech2.title}</em>
                        `

              tooltip
                .html(tooltipHtml)
                .style('display', 'block')
                .style('left', event.pageX + 10 + 'px')
                .style('top', event.pageY - 10 + 'px')
            })
            .on('mouseout', function () {
              tooltip.style('display', 'none')
            })

          // Add country labels on axes
          const countries = [...new Set(speeches.map((s) => s.country))].sort()
          const countryPositions = new Map()

          // Calculate country positions
          speeches.forEach((speech, i) => {
            if (!countryPositions.has(speech.country)) {
              countryPositions.set(speech.country, [])
            }
            countryPositions.get(speech.country).push(i)
          })

          // Add country labels
          countries.forEach((country) => {
            const positions = countryPositions.get(country)
            const avgPos =
              positions.reduce((a, b) => a + b, 0) / positions.length

            // X-axis label (top)
            g.append('text')
              .attr('class', 'axis-label')
              .attr('x', avgPos * cellSize + cellSize / 2)
              .attr('y', -10)
              .attr('text-anchor', 'middle')
              .text(country)

            // Y-axis label (left)
            g.append('text')
              .attr('class', 'axis-label')
              .attr('x', -10)
              .attr('y', avgPos * cellSize + cellSize / 2)
              .attr('text-anchor', 'end')
              .attr('alignment-baseline', 'middle')
              .text(country)
          })

          // Add country group separators
          let currentPos = 0
          countries.forEach((country) => {
            const positions = countryPositions.get(country)
            currentPos += positions.length

            if (currentPos < speeches.length) {
              // Vertical line
              g.append('line')
                .attr('class', 'country-group')
                .attr('x1', currentPos * cellSize)
                .attr('x2', currentPos * cellSize)
                .attr('y1', 0)
                .attr('y2', speeches.length * cellSize)

              // Horizontal line
              g.append('line')
                .attr('class', 'country-group')
                .attr('x1', 0)
                .attr('x2', speeches.length * cellSize)
                .attr('y1', currentPos * cellSize)
                .attr('y2', currentPos * cellSize)
            }
          })
        }

        // Event listeners
        document
          .getElementById('threshold')
          .addEventListener('input', function () {
            currentThreshold = parseFloat(this.value)
            document.getElementById('threshold-value').textContent =
              currentThreshold.toFixed(2)
            updateMatrix()
          })

        document
          .getElementById('cellSize')
          .addEventListener('change', function () {
            currentCellSize = parseInt(this.value)
            updateMatrix()
          })

        // Initial render
        updateMatrix()
      }
    </script>
  </body>
</html>
